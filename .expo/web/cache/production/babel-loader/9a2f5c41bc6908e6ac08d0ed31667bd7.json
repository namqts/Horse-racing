{"ast":null,"code":"import _toConsumableArray from\"@babel/runtime/helpers/toConsumableArray\";import _slicedToArray from\"@babel/runtime/helpers/slicedToArray\";function _createForOfIteratorHelperLoose(o,allowArrayLike){var it=typeof Symbol!==\"undefined\"&&o[Symbol.iterator]||o[\"@@iterator\"];if(it)return(it=it.call(o)).next.bind(it);if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length===\"number\"){if(it)o=it;var i=0;return function(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};};}throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o===\"string\")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n===\"Object\"&&o.constructor)n=o.constructor.name;if(n===\"Map\"||n===\"Set\")return Array.from(o);if(n===\"Arguments\"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}import{useMenuTriggerState}from\"@react-stately/menu\";import{useEffect,useMemo,useRef,useState}from\"react\";import{useControlledState}from\"@react-stately/utils\";import{ListCollection,useSingleSelectListState}from\"@react-stately/list\";import _babelRuntimeHelpersEsmExtends from\"@babel/runtime/helpers/esm/extends\";export function useComboBoxState(props){var _props$defaultInputVa,_props$items,_ref,_props$selectedKey;var defaultFilter=props.defaultFilter,_props$menuTrigger=props.menuTrigger,menuTrigger=_props$menuTrigger===void 0?'input':_props$menuTrigger,_props$allowsEmptyCol=props.allowsEmptyCollection,allowsEmptyCollection=_props$allowsEmptyCol===void 0?false:_props$allowsEmptyCol,allowsCustomValue=props.allowsCustomValue,_props$shouldCloseOnB=props.shouldCloseOnBlur,shouldCloseOnBlur=_props$shouldCloseOnB===void 0?true:_props$shouldCloseOnB;var _useState=useState(false),_useState2=_slicedToArray(_useState,2),isFocused=_useState2[0],setFocusedState=_useState2[1];var _useControlledState=useControlledState(props.inputValue,(_props$defaultInputVa=props.defaultInputValue)!=null?_props$defaultInputVa:'',props.onInputChange),_useControlledState2=_slicedToArray(_useControlledState,2),inputValue=_useControlledState2[0],setInputValue=_useControlledState2[1];var onSelectionChange=function onSelectionChange(key){if(props.onSelectionChange){props.onSelectionChange(key);}if(props.isOpen===undefined||props.selectedKey===undefined){if(key===selectedKey){resetInputValue();triggerState.close();}}};var _useSingleSelectListS=useSingleSelectListState(_babelRuntimeHelpersEsmExtends({},props,{onSelectionChange:onSelectionChange,items:(_props$items=props.items)!=null?_props$items:props.defaultItems})),collection=_useSingleSelectListS.collection,selectionManager=_useSingleSelectListS.selectionManager,selectedKey=_useSingleSelectListS.selectedKey,setSelectedKey=_useSingleSelectListS.setSelectedKey,selectedItem=_useSingleSelectListS.selectedItem,disabledKeys=_useSingleSelectListS.disabledKeys;var filteredCollection=useMemo(function(){return props.items!=null||!defaultFilter?collection:$b1b6afed698df4428b7ed319af4b90$var$filterCollection(collection,inputValue,defaultFilter);},[collection,inputValue,defaultFilter,props.items]);var triggerState=useMenuTriggerState(props);var open=function open(focusStrategy){if(allowsEmptyCollection||filteredCollection.size>0){triggerState.open(focusStrategy);}};var toggle=function toggle(focusStrategy){if(!(allowsEmptyCollection||filteredCollection.size>0)&&!triggerState.isOpen){return;}triggerState.toggle(focusStrategy);};var lastValue=useRef(inputValue);var resetInputValue=function resetInputValue(){var _collection$getItem$t,_collection$getItem;var itemText=(_collection$getItem$t=(_collection$getItem=collection.getItem(selectedKey))==null?void 0:_collection$getItem.textValue)!=null?_collection$getItem$t:'';lastValue.current=itemText;setInputValue(itemText);};var isInitialRender=useRef(true);var lastSelectedKey=useRef((_ref=(_props$selectedKey=props.selectedKey)!=null?_props$selectedKey:props.defaultSelectedKey)!=null?_ref:null);useEffect(function(){if(isFocused&&filteredCollection.size>0&&!triggerState.isOpen&&inputValue!==lastValue.current&&menuTrigger!=='manual'&&(props.isOpen===undefined||props.inputValue===undefined)){open();}if(!allowsEmptyCollection&&triggerState.isOpen&&filteredCollection.size===0&&(props.isOpen===undefined||props.items===undefined)){triggerState.close();}if(selectedKey!=null&&selectedKey!==lastSelectedKey.current&&(props.isOpen===undefined||props.selectedKey===undefined)){triggerState.close();}if(inputValue!==lastValue.current){selectionManager.setFocusedKey(null);if(inputValue===''&&(props.inputValue===undefined||props.selectedKey===undefined)){setSelectedKey(null);}}if(isInitialRender.current&&props.inputValue===undefined&&props.defaultInputValue===undefined){resetInputValue();}if(selectedKey!==lastSelectedKey.current&&(props.inputValue===undefined||props.selectedKey===undefined)){resetInputValue();}else{lastValue.current=inputValue;}isInitialRender.current=false;lastSelectedKey.current=selectedKey;});useEffect(function(){if(!triggerState.isOpen){selectionManager.setFocusedKey(null);}},[triggerState.isOpen,selectionManager]);var commitCustomValue=function commitCustomValue(){var shouldClose=false;lastSelectedKey.current=null;setSelectedKey(null);if(selectedKey===null&&props.onSelectionChange){props.onSelectionChange(null);}shouldClose=props.isOpen==null||props.selectedKey===undefined;if(shouldClose){triggerState.close();}};var commit=function commit(){if(triggerState.isOpen&&selectionManager.focusedKey!=null){if(selectedKey===selectionManager.focusedKey){resetInputValue();triggerState.close();}else{setSelectedKey(selectionManager.focusedKey);}}else if(allowsCustomValue){commitCustomValue();}};var setFocused=function setFocused(isFocused){if(isFocused){if(menuTrigger==='focus'){open();}}else if(shouldCloseOnBlur){var _collection$getItem$t2,_collection$getItem2;var itemText=(_collection$getItem$t2=(_collection$getItem2=collection.getItem(selectedKey))==null?void 0:_collection$getItem2.textValue)!=null?_collection$getItem$t2:'';if(allowsCustomValue&&inputValue!==itemText){commitCustomValue();}else{resetInputValue();triggerState.close();}}setFocusedState(isFocused);};return _babelRuntimeHelpersEsmExtends({},triggerState,{toggle:toggle,open:open,selectionManager:selectionManager,selectedKey:selectedKey,setSelectedKey:setSelectedKey,disabledKeys:disabledKeys,isFocused:isFocused,setFocused:setFocused,selectedItem:selectedItem,collection:filteredCollection,inputValue:inputValue,setInputValue:setInputValue,commit:commit});}function $b1b6afed698df4428b7ed319af4b90$var$filterCollection(collection,inputValue,filter){return new ListCollection($b1b6afed698df4428b7ed319af4b90$var$filterNodes(collection,inputValue,filter));}function $b1b6afed698df4428b7ed319af4b90$var$filterNodes(nodes,inputValue,filter){var filteredNode=[];for(var _iterator=_createForOfIteratorHelperLoose(nodes),_step;!(_step=_iterator()).done;){var node=_step.value;if(node.type==='section'&&node.hasChildNodes){var filtered=$b1b6afed698df4428b7ed319af4b90$var$filterNodes(node.childNodes,inputValue,filter);if(_toConsumableArray(filtered).length>0){filteredNode.push(_babelRuntimeHelpersEsmExtends({},node,{childNodes:filtered}));}}else if(node.type!=='section'&&filter(node.textValue,inputValue)){filteredNode.push(node);}}return filteredNode;}","map":{"version":3,"sources":["packages/@react-stately/combobox/src/useComboBoxState.ts"],"names":["useComboBoxState","props","defaultFilter","menuTrigger","allowsEmptyCollection","allowsCustomValue","shouldCloseOnBlur","isFocused","setFocusedState","useState","inputValue","setInputValue","useControlledState","defaultInputValue","onInputChange","onSelectionChange","key","isOpen","undefined","selectedKey","resetInputValue","triggerState","close","collection","selectionManager","setSelectedKey","selectedItem","disabledKeys","useSingleSelectListState","items","defaultItems","filteredCollection","useMemo","filterCollection","useMenuTriggerState","open","focusStrategy","size","toggle","lastValue","useRef","itemText","getItem","textValue","current","isInitialRender","lastSelectedKey","defaultSelectedKey","useEffect","setFocusedKey","commitCustomValue","shouldClose","commit","focusedKey","setFocused","filter","ListCollection","filterNodes","nodes","filteredNode","node","type","hasChildNodes","filtered","childNodes","length","push"],"mappings":"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","sourcesContent":["/*\n * Copyright 2020 Adobe. All rights reserved.\n * This file is licensed to you under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License. You may obtain a copy\n * of the License at http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under\n * the License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS\n * OF ANY KIND, either express or implied. See the License for the specific language\n * governing permissions and limitations under the License.\n */\n\nimport {Collection, FocusStrategy, Node} from '@react-types/shared';\nimport {ComboBoxProps} from '@react-types/combobox';\nimport {ListCollection, useSingleSelectListState} from '@react-stately/list';\nimport {SelectState} from '@react-stately/select';\nimport {useControlledState} from '@react-stately/utils';\nimport {useEffect, useMemo, useRef, useState} from 'react';\nimport {useMenuTriggerState} from '@react-stately/menu';\n\nexport interface ComboBoxState<T> extends SelectState<T> {\n  /** The current value of the combo box input. */\n  inputValue: string,\n  /** Sets the value of the combo box input. */\n  setInputValue(value: string): void,\n  /** Selects the currently focused item and updates the input value. */\n  commit(): void\n}\n\ntype FilterFn = (textValue: string, inputValue: string) => boolean;\ninterface ComboBoxStateProps<T> extends ComboBoxProps<T> {\n  /** The filter function used to determine if a option should be included in the combo box list. */\n  defaultFilter?: FilterFn,\n  /** Whether the combo box allows the menu to be open when the collection is empty. */\n  allowsEmptyCollection?: boolean,\n  /** Whether the combo box menu should close on blur. */\n  shouldCloseOnBlur?: boolean\n}\n\n/**\n * Provides state management for a combo box component. Handles building a collection\n * of items from props and manages the option selection state of the combo box. In addition, it tracks the input value,\n * focus state, and other properties of the combo box.\n */\nexport function useComboBoxState<T extends object>(props: ComboBoxStateProps<T>): ComboBoxState<T> {\n  let {\n    defaultFilter,\n    menuTrigger = 'input',\n    allowsEmptyCollection = false,\n    allowsCustomValue,\n    shouldCloseOnBlur = true\n  } = props;\n\n  let [isFocused, setFocusedState] = useState(false);\n  let [inputValue, setInputValue] = useControlledState(\n    props.inputValue,\n    props.defaultInputValue ?? '',\n    props.onInputChange\n  );\n\n  let onSelectionChange = (key) => {\n    if (props.onSelectionChange) {\n      props.onSelectionChange(key);\n    }\n\n    // If open state or selectedKey is uncontrolled and key is the same, reset the inputValue and close the menu\n    // (scenario: user clicks on already selected option)\n    if (props.isOpen === undefined || props.selectedKey === undefined) {\n      if (key === selectedKey) {\n        resetInputValue();\n        triggerState.close();\n      }\n    }\n  };\n\n  let {collection, selectionManager, selectedKey, setSelectedKey, selectedItem, disabledKeys} = useSingleSelectListState({\n    ...props,\n    onSelectionChange,\n    items: props.items ?? props.defaultItems\n  });\n\n  let filteredCollection = useMemo(() => (\n    // No default filter if items are controlled.\n    props.items != null || !defaultFilter\n      ? collection\n      : filterCollection(collection, inputValue, defaultFilter)\n  ), [collection, inputValue, defaultFilter, props.items]);\n\n  let triggerState = useMenuTriggerState(props);\n  let open = (focusStrategy?: FocusStrategy) => {\n    // Prevent open operations from triggering if there is nothing to display\n    if (allowsEmptyCollection || filteredCollection.size > 0) {\n      triggerState.open(focusStrategy);\n    }\n  };\n\n  let toggle = (focusStrategy?: FocusStrategy) => {\n    // If the menu is closed and there is nothing to display, early return so toggle isn't called to prevent extraneous onOpenChange\n    if (!(allowsEmptyCollection || filteredCollection.size > 0) && !triggerState.isOpen) {\n      return;\n    }\n\n    triggerState.toggle(focusStrategy);\n  };\n\n  let lastValue = useRef(inputValue);\n  let resetInputValue = () => {\n    let itemText = collection.getItem(selectedKey)?.textValue ?? '';\n    lastValue.current = itemText;\n    setInputValue(itemText);\n  };\n\n  let isInitialRender = useRef(true);\n  let lastSelectedKey = useRef(props.selectedKey ?? props.defaultSelectedKey ?? null);\n  useEffect(() => {\n    // If open state or inputValue is uncontrolled, open and close automatically when the input value changes,\n    // the input is if focused, and there are items in the collection.\n    if (\n      isFocused &&\n      filteredCollection.size > 0 &&\n      !triggerState.isOpen &&\n      inputValue !== lastValue.current &&\n      menuTrigger !== 'manual' &&\n      (props.isOpen === undefined || props.inputValue === undefined)\n    ) {\n      open();\n    }\n\n    // Close the menu if the collection is empty and either open state or items are uncontrolled.\n    if (\n      !allowsEmptyCollection &&\n      triggerState.isOpen &&\n      filteredCollection.size === 0 &&\n      (props.isOpen === undefined || props.items === undefined)\n    ) {\n      triggerState.close();\n    }\n\n    // Close when an item is selected, if open state or selectedKey is uncontrolled.\n    if (\n      selectedKey != null &&\n      selectedKey !== lastSelectedKey.current &&\n      (props.isOpen === undefined || props.selectedKey === undefined)\n    ) {\n      triggerState.close();\n    }\n\n    // Clear focused key when input value changes.\n    if (inputValue !== lastValue.current) {\n      selectionManager.setFocusedKey(null);\n\n      // Set selectedKey to null when the user clears the input.\n      // If controlled, this is the application developer's responsibility.\n      if (inputValue === '' && (props.inputValue === undefined || props.selectedKey === undefined)) {\n        setSelectedKey(null);\n      }\n    }\n\n    // If it is the intial render and inputValue isn't controlled nor has an intial value, set input to match current selected key if any\n    if (isInitialRender.current && (props.inputValue === undefined && props.defaultInputValue === undefined)) {\n      resetInputValue();\n    }\n\n    // If the selectedKey changed, update the input value.\n    // Do nothing if both inputValue and selectedKey are controlled.\n    // In this case, it's the user's responsibility to update inputValue in onSelectionChange. In addition, we preserve the defaultInputValue\n    // on initial render, even if it doesn't match the selected item's text.\n    if (\n      selectedKey !== lastSelectedKey.current &&\n      (props.inputValue === undefined || props.selectedKey === undefined)\n    ) {\n      resetInputValue();\n    } else {\n      lastValue.current = inputValue;\n    }\n\n    isInitialRender.current = false;\n    lastSelectedKey.current = selectedKey;\n  });\n\n  useEffect(() => {\n    // Reset focused key when the menu closes\n    if (!triggerState.isOpen) {\n      selectionManager.setFocusedKey(null);\n    }\n  }, [triggerState.isOpen, selectionManager]);\n\n  let commitCustomValue = () => {\n    let shouldClose = false;\n    lastSelectedKey.current = null;\n    setSelectedKey(null);\n\n    // If previous key was already null, need to manually call onSelectionChange since it won't be triggered by a setSelectedKey call\n    // This allows the application to control whether or not to close the menu on custom value commit\n    if (selectedKey === null && props.onSelectionChange) {\n      props.onSelectionChange(null);\n    }\n\n    // Should close menu ourselves if component open state or selected key is uncontrolled and therefore won't be closed by a user defined event handler\n    shouldClose = props.isOpen == null || props.selectedKey === undefined;\n\n\n    // Close if no other event will be fired. Otherwise, allow the\n    // application to control this based on that event.\n    if (shouldClose) {\n      triggerState.close();\n    }\n  };\n\n  let commit = () => {\n    if (triggerState.isOpen && selectionManager.focusedKey != null) {\n      // Reset inputValue and close menu here if the selected key is already the focused key. Otherwise\n      // fire onSelectionChange to allow the application to control the closing.\n      if (selectedKey === selectionManager.focusedKey) {\n        resetInputValue();\n        triggerState.close();\n      } else {\n        setSelectedKey(selectionManager.focusedKey);\n      }\n    } else if (allowsCustomValue) {\n      commitCustomValue();\n    }\n  };\n\n  let setFocused = (isFocused: boolean) => {\n    if (isFocused) {\n      if (menuTrigger === 'focus') {\n        open();\n      }\n    } else if (shouldCloseOnBlur) {\n      let itemText = collection.getItem(selectedKey)?.textValue ?? '';\n      if (allowsCustomValue && inputValue !== itemText) {\n        commitCustomValue();\n      } else {\n        resetInputValue();\n        // Close menu if blurring away from the combobox\n        // Specifically handles case where user clicks away from the field\n        triggerState.close();\n      }\n    }\n\n    setFocusedState(isFocused);\n  };\n\n  return {\n    ...triggerState,\n    toggle,\n    open,\n    selectionManager,\n    selectedKey,\n    setSelectedKey,\n    disabledKeys,\n    isFocused,\n    setFocused,\n    selectedItem,\n    collection: filteredCollection,\n    inputValue,\n    setInputValue,\n    commit\n  };\n}\n\nfunction filterCollection<T extends object>(collection: Collection<Node<T>>, inputValue: string, filter: FilterFn): Collection<Node<T>> {\n  return new ListCollection(filterNodes(collection, inputValue, filter));\n}\n\nfunction filterNodes<T>(nodes: Iterable<Node<T>>, inputValue: string, filter: FilterFn): Iterable<Node<T>> {\n  let filteredNode = [];\n  for (let node of nodes) {\n    if (node.type === 'section' && node.hasChildNodes) {\n      let filtered = filterNodes(node.childNodes, inputValue, filter);\n      if ([...filtered].length > 0) {\n        filteredNode.push({...node, childNodes: filtered});\n      }\n    } else if (node.type !== 'section' && filter(node.textValue, inputValue)) {\n      filteredNode.push(node);\n    }\n  }\n  return filteredNode;\n}\n"]},"metadata":{},"sourceType":"module"}